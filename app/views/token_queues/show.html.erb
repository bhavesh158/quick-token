<div
  class="relative flex min-h-screen w-full flex-col bg-gray-50 font-display text-slate-900"
  data-queue-view="customer"
  data-queue-token="<%= @token_queue.unique_token %>"
  data-customer-id="<%= @current_customer&.id %>"
  data-queue-status="<%= json_escape(@queue_status.to_json) %>"
>
  <!-- Header -->
  <header class="sticky top-0 z-50 flex items-center justify-between border-b border-gray-200 bg-white px-4 py-3">
    <div class="flex items-center gap-2">
      <div class="flex h-8 w-8 items-center justify-center rounded bg-primary text-white">
        <span class="material-symbols-outlined text-lg">confirmation_number</span>
      </div>
      <div class="min-w-0">
        <h2 class="text-sm font-bold text-slate-900 truncate"><%= @token_queue.name %></h2>
        <p class="text-[10px] font-medium text-slate-500">
          <%= @token_queue.completed? ? 'Queue Closed' : 'Accepting customers' %>
        </p>
      </div>
    </div>
    <div class="flex items-center gap-1 rounded bg-emerald-100 px-2 py-0.5">
      <span class="relative flex h-1.5 w-1.5">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span>
      </span>
      <span class="text-[10px] font-bold text-emerald-700">LIVE</span>
    </div>
  </header>

  <main class="flex-1 px-4 py-6">
    <div class="mx-auto max-w-lg space-y-4">
      
      <!-- Queue Closed Banner -->
      <% if @token_queue.completed? %>
        <div class="rounded-lg border border-amber-300 bg-amber-50 p-4 text-center">
          <span class="material-symbols-outlined text-amber-600 text-3xl">event_busy</span>
          <h3 class="mt-2 text-sm font-bold text-amber-800">Queue Closed</h3>
          <p class="text-xs text-amber-700">This queue is no longer accepting new customers.</p>
        </div>
      <% end %>

      <!-- Join Queue Card -->
      <% if !@token_queue.completed? %>
        <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="mb-4 flex items-center gap-2">
            <div class="flex h-9 w-9 flex-shrink-0 items-center justify-center rounded bg-primary/10 text-primary">
              <span class="material-symbols-outlined text-lg">person_add</span>
            </div>
            <div class="min-w-0">
              <h2 class="text-base font-bold text-slate-900">Join the Queue</h2>
              <p class="text-xs text-slate-500">Enter your name to get in line</p>
            </div>
          </div>
          
          <%= form_with(model: @join_customer, url: join_queue_path(token_queue_token: @token_queue.unique_token), html: { class: "space-y-3" }) do |form| %>
            <div>
              <%= form.label :name, "Your Name", class: "mb-1 block text-xs font-semibold text-slate-700" %>
              <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-base">badge</span>
                <%= form.text_field :name, required: true, placeholder: "Enter your name", class: "w-full rounded-lg border border-gray-300 bg-white pl-10 pr-3 py-2.5 text-sm placeholder-gray-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" %>
              </div>
            </div>
            <%= form.submit "Join Queue", class: "w-full rounded-lg bg-primary py-2.5 text-sm font-bold text-white hover:bg-primary/90" %>
          <% end %>
          
          <% if @current_customer %>
            <div class="mt-3 pt-3 border-t border-gray-100">
              <%= form_with(url: leave_queue_path(token_queue_token: @token_queue.unique_token, id: @current_customer.id), method: :delete) do |form| %>
                <%= form.submit "Leave Queue", class: "w-full rounded-lg border-2 border-gray-200 bg-white py-2.5 text-sm font-bold text-gray-600 hover:bg-red-50 hover:text-red-600 hover:border-red-300" %>
              <% end %>
            </div>
          <% else %>
            <button class="mt-3 w-full rounded-lg border-2 border-gray-200 bg-white py-2.5 text-sm font-bold text-gray-400 cursor-not-allowed" disabled>Leave Queue</button>
          <% end %>
        </div>
      <% end %>

      <!-- Customer Dashboard -->
      <% if @current_customer %>
        <!-- Position Card -->
        <div class="rounded-xl bg-primary p-5 text-center text-white shadow-lg">
          <div class="mb-2 text-[10px] font-semibold uppercase tracking-wider opacity-90">Your Ticket</div>
          <div class="mb-4 inline-flex h-16 w-16 items-center justify-center rounded-2xl bg-white/20">
            <span class="text-3xl font-black" id="customer-ticket-id"><%= @current_customer.id %></span>
          </div>
          
          <div class="mb-2 text-[10px] font-semibold uppercase tracking-wider opacity-90">Your Position</div>
          <div class="mb-4 text-6xl font-black" id="customer-position">-</div>
          
          <div class="mb-4 h-1.5 w-full rounded-full bg-white/30">
            <div class="h-full rounded-full bg-white" id="position-progress-bar" style="width: 0%"></div>
          </div>
          
          <div class="inline-flex items-center gap-1.5 rounded bg-white/20 px-3 py-1.5 text-xs font-semibold backdrop-blur">
            <span class="material-symbols-outlined text-sm">timer</span>
            <span id="estimated-wait">-</span>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-lg border border-gray-200 bg-white p-3">
            <div class="mb-1 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-primary text-base">group</span>
              <span class="text-[10px] font-semibold uppercase text-slate-500">Waiting</span>
            </div>
            <p class="text-xl font-bold text-slate-900" id="total-waiting-count">-</p>
          </div>
          <div class="rounded-lg border border-gray-200 bg-white p-3">
            <div class="mb-1 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-emerald-600 text-base">person</span>
              <span class="text-[10px] font-semibold uppercase text-slate-500">Serving</span>
            </div>
            <p class="text-sm font-bold text-slate-900 truncate" id="now-serving-name">-</p>
          </div>
        </div>

        <!-- Leave Button -->
        <div class="rounded-lg border border-gray-200 bg-white p-3">
          <p class="mb-2 text-xs font-semibold text-slate-700">No longer waiting?</p>
          <%= form_with(url: leave_queue_path(token_queue_token: @token_queue.unique_token, id: @current_customer.id), method: :delete) do |form| %>
            <%= form.submit "Leave Queue", class: "w-full rounded border border-red-300 bg-red-50 py-2 text-xs font-bold text-red-700 hover:bg-red-100" %>
          <% end %>
        </div>
      <% end %>

      <!-- Now Serving -->
      <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 bg-emerald-50 px-4 py-2.5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-emerald-600 text-lg">support_agent</span>
              <h3 class="text-sm font-bold text-slate-800">Now Serving</h3>
            </div>
            <span class="animate-pulse rounded bg-emerald-500 px-2 py-0.5 text-[10px] font-bold uppercase text-white">Live</span>
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-center gap-3">
            <div class="flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-full bg-primary/10 text-primary">
              <span class="material-symbols-outlined text-2xl">person</span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-xs text-slate-500">Current Customer</p>
              <p class="text-base font-bold text-slate-900 truncate" id="now-serving">No one yet</p>
              <p class="text-[10px] text-slate-400" id="now-serving-time"></p>
            </div>
            <div class="flex-shrink-0 rounded-lg bg-emerald-100 px-3 py-1.5 text-center">
              <span class="text-[10px] font-semibold uppercase text-emerald-700">#</span>
              <p class="text-lg font-black text-emerald-700" id="now-serving-ticket">--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Queue List -->
      <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 bg-gray-50 px-4 py-2.5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-lg">queue</span>
              <h3 class="text-sm font-bold text-slate-800">Waiting Queue</h3>
            </div>
            <span class="rounded bg-primary/10 px-2 py-1 text-xs font-bold text-primary" id="queue-count">0 people</span>
          </div>
        </div>
        <div id="queue-list" class="divide-y divide-gray-100">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Info -->
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <div class="flex gap-2">
          <span class="material-symbols-outlined text-primary text-base flex-shrink-0">info</span>
          <div>
            <p class="text-xs font-semibold text-slate-700">Real-time Updates</p>
            <p class="text-[10px] text-slate-500">Keep this page open to receive live updates.</p>
          </div>
        </div>
      </div>

      <!-- Share -->
      <div class="rounded-lg border border-gray-200 bg-white p-3">
        <p class="mb-2 text-xs font-semibold text-slate-700">Share this queue</p>
        <div class="flex gap-2">
          <input type="text" readonly value="<%= token_queue_url(@token_queue.unique_token) %>" id="queue-share-link" class="flex-1 rounded border border-gray-300 bg-gray-50 px-3 py-2 text-xs text-slate-600 focus:outline-none">
          <button type="button" onclick="copyShareLink()" class="rounded bg-primary px-3 py-2 text-xs font-bold text-white hover:bg-primary/90 flex-shrink-0">Copy</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t border-gray-200 bg-white px-4 py-4 text-center">
    <p class="text-[10px] text-slate-500">Â© <%= Time.current.year %> QuickToken</p>
  </footer>
</div>

<script>
  function copyShareLink() {
    const link = document.getElementById("queue-share-link")
    if (!link) return
    link.select()
    navigator.clipboard.writeText(link.value).then(() => {
      showToast("Link copied!", "success")
    })
  }

  function showToast(message, type = "info") {
    const container = document.getElementById("toast-container")
    if (!container) return
    
    const toast = document.createElement("div")
    const colors = {
      success: "border-emerald-200 bg-emerald-50 text-emerald-800",
      error: "border-red-200 bg-red-50 text-red-700",
      info: "border-blue-200 bg-blue-50 text-blue-800"
    }
    const icons = { success: "check_circle", error: "error", info: "info" }
    
    toast.className = `toast-notification flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium shadow-lg ${colors[type]}`
    toast.innerHTML = `<span class="material-symbols-outlined text-base">${icons[type]}</span><span>${message}</span>`
    
    container.appendChild(toast)
    setTimeout(() => {
      toast.style.transition = "opacity 0.3s"
      toast.style.opacity = "0"
      setTimeout(() => toast.remove(), 300)
    }, 4000)
  }
</script>
